version: '3.8'
services:
  maria:
    container_name: maria
    image: bitnami/mariadb:11.2.3
    restart: unless-stopped
    ports:
      - 3306:3306
    volumes:
      - maria_db:/bitnami/mariadb
      - ${PWD}/db_conf/fuelrod:/etc/mysql/conf.d
      - ${PWD}/db-backup:/usr/fuelrod
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASS}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASS}
    networks:
      - internal
      - web

  adminer:
    container_name: adminer
    image: adminer
    restart: unless-stopped
    ports:
      - 8080:8080
    environment:
      ADMINER_DEFAULT_DB_DRIVER: mysql
      ADMINER_DEFAULT_DB_HOST: maria
      ADMINER_DEFAULT_DB_NAME: ${DB_NAME}
      ADMINER_DESIGN: ${THEME}
      ADMINER_PLUGINS: ${PLUGINS}
    networks:
      - web
      - internal

  fuelrod:
    container_name: fuelrod
    image: tsobu/fuelrod-service-api:${FUELROD_TAG}
    restart: unless-stopped
    ports:
      - 9000:9000
    volumes:
      - ${PWD}/log:/log
      - ${PWD}/uploads:/uploads
      - ${PWD}/downloads:/downloads
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DEBUG: ${SPRING_DEBUG}
      TRACE: ${TRACE}
      DB_CLASS: ${DB_CLASS}
      DB_URL: ${DB_URL}
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      OPT_OUT: ${OPT_OUT}
      NO_QUEUE_WORDS: ${NO_QUEUE_WORDS}
      DUPLICATE_WINDOW: ${DUPLICATE_WINDOW}
      DEFAULT_SENDER: ${DEFAULT_SENDER}
      SMS_API_USER: ${SMS_API_USER}
      SMS_API_KEY: ${SMS_API_KEY}
      SMS_API_USER_B: ${SMS_API_USER_B}
      SMS_API_KEY_B: ${SMS_API_KEY_B}
      TEXT_SMS_API_KEY: ${TEXT_SMS_API_KEY}
      PUSH_BULLET_KEY: ${PUSH_BULLET_KEY}
      JWT_SECRET: ${JWT_SECRET}
      JWT_TOKEN_VALIDITY: ${JWT_TOKEN_VALIDITY}
      JWT_REFRESH_TOKEN_VALIDITY: ${JWT_REFRESH_TOKEN_VALIDITY}
      JAVA_OPTS: -Xmx512M -Xms512M
    networks:
      - web
      - internal
    depends_on:
      - maria

  migration:
    container_name: fuelrod-migration
    image: tsobu/fuelrod-migration:${FUELROD_TAG}
    restart: "no"
    volumes:
      - ${PWD}/log:/log
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      DEBUG: ${SPRING_DEBUG}
      TRACE: ${TRACE}
      DB_URL: ${DB_URL}
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      CLEAR_CHECKSUM: ${CLEAR_CHECKSUM}
    networks:
      - internal
    depends_on:
      - maria

  portal:
    container_name: portal
    image: tsobu/fuelrod-sms-portal:${PORTAL_TAG}
    restart: unless-stopped
    ports:
      - 3004:80
    networks:
      - web
      - internal
    depends_on:
      - fuelrod

  legacy:
    container_name: legacy
    image: tsobu/fuelrod-legacy-portal:${LEGACY_PORTAL}
    restart: unless-stopped
    ports:
      - 3005:80
    networks:
      - web
      - internal
    depends_on:
      - fuelrod

  akilimo:
    container_name: akilimo-api
    image: iita/akilimo-service:${AKILIMO_VERSION_TAG}
    restart: unless-stopped
    ports:
      - 8098:8098
    volumes:
      - ${PWD}/log:/log
      - /mnt/extra_storage/ona_data:/mnt/extra_storage/ona_data
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      DB_URL: ${AKILIMO_DB_URL}
      DB_USER: ${AKILIMO_USER}
      DB_PASS: ${AKILIMO_DB_PASS}
      SMS_USER: ${SMS_USER}
      SMS_PASS: ${SMS_PASS}
      PLUMBER_BASE: ${PLUMBER_BASE}
      COMPUTE_NG: ${COMPUTE_NG}
      COMPUTE_TZ: ${COMPUTE_TZ}
      COMPUTE_GH: ${COMPUTE_GH}
      COMPUTE_BI: ${COMPUTE_BI}
      COMPUTE_RW: ${COMPUTE_RW}
      VERIFY_CERT: ${VERIFY_CERT}
      TZS_USD_RATE: ${TZS_USD}
      NGN_USD: ${NGN_USD}
      KES_USD: ${KES_USD}
      RATE_TYPE: ${RATE_TYPE}
      RATE_ENABLED: ${RATE_ENABLED}
      MAX_REQUESTS: ${MAX_REQUESTS}
      OUTPUT_PATH: ${OUTPUT_PATH}
    networks:
      - web
      - internal
    depends_on:
      - maria

  akilimo-migration:
    container_name: akilimo-migration
    image: iita/akilimo-service-migration:${AKILIMO_VERSION_TAG}
    restart: "no"
    volumes:
      - ${PWD}/log:/log
    environment:
      DEBUG: ${SPRING_DEBUG}
      DB_URL: ${AKILIMO_DB_URL}
      DB_USER: ${AKILIMO_USER}
      DB_PASS: ${AKILIMO_DB_PASS}
      CLEAR_CHECKSUM: ${CLEAR_CHECKSUM}
    networks:
      - web
      - internal
    depends_on:
      - maria

networks:
  internal:
    external: false
  web:
    external: true

volumes:
  maria_db: {}
  agwise-pg: {}
  pg-admin: {}
  metabase-data: {}
